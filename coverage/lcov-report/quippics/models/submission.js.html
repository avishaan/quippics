<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for quippics/models/submission.js</title>
    <meta charset="utf-8">

    <link rel="stylesheet" href="../../prettify.css">

    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Helvetica Neue, Helvetica,Arial;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 10em;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Consolas, Menlo, Monaco, monospace;
            margin: 0;
            padding: 0;
            line-height: 14px;
            font-size: 14px;
            -moz-tab-size: 2;
            -o-tab-size:  2;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { text-decoration: none; color: #000; }
        div.coverage-summary a:visited { text-decoration: none; color: #333; }
        div.coverage-summary a:hover { text-decoration: underline; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: url("https://yui-s.yahooapis.com/3.6.0/build/datatable-sort/assets/skins/sam/sort-arrow-sprite.png") no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">quippics/models/submission.js</span></h1>
    <h2>
        
        Statements: <span class="metric">26.23% <small>(16 / 61)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 18)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 14)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">26.23% <small>(16 / 61)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">quippics/models/</a> &#187; submission.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var mongoose = require("mongoose");
var fs = require('fs');
var _ = require('underscore');
var Challenge = require('../models/challenge.js');
var User = require('../models/user.js');
var Ballot = require('../models/ballot.js');
var Comment = require("../models/comment.js");
&nbsp;
var submissionSchema = new mongoose.Schema({
  createdOn: { type: Date, default: Date.now },
  owner: { type: mongoose.Schema.Types.ObjectId, ref: 'User'},
  //these are users who are invited at the creation of the submission
  image:
  { data: Buffer, contentType: String },
  thumbnail:
  { data: Buffer, contentType: String },
  ballots: [Ballot.schema],
  comments: [Comment.schema],
  score: { type: Number, default: 0}, //we calculate this in the pre save
  rank: { type: Number, default: 0}, //this should be calculated before every ballot added
  challenge: { type: mongoose.Schema.Types.ObjectId, ref: "Challenge"} //we save the challenge id of each submission for easy querying
});
&nbsp;
//do the following before each save
submissionSchema.pre('save', <span class="fstat-no" title="function not covered" >function(next){</span> //right before saving a new submission, make a new entry in the activity collection
<span class="cstat-no" title="statement not covered" >  this.wasNew = this.isNew; </span>//we use this in the post 'save' hook since it has no way to let us know if a doc is/was new
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (typeof this.ballots !== "undefined" &amp;&amp; this.isModified()){ //if there are ballots in the submission</span>
    //calculate the average score
<span class="cstat-no" title="statement not covered" >    var tot = 0;</span>
<span class="cstat-no" title="statement not covered" >    this.ballots.forEach(<span class="fstat-no" title="function not covered" >function(element){</span></span>
<span class="cstat-no" title="statement not covered" >      tot += element.score;</span>
    });
    //calculate and store the score in the document //TODO, this should be done only when a ballot is added, not just a submission
<span class="cstat-no" title="statement not covered" >    this.score = tot/this.ballots.length;</span>
<span class="cstat-no" title="statement not covered" >    next();</span>
  } else {
<span class="cstat-no" title="statement not covered" >    next();</span>
  }
});
&nbsp;
//do the following after each successful save
submissionSchema.post('save', <span class="fstat-no" title="function not covered" >function(){</span>
<span class="cstat-no" title="statement not covered" >  if (this.wasNew){</span>
    //emit the specific wasNew event
<span class="cstat-no" title="statement not covered" >    this.emit('new');</span>
  } else {
<span class="cstat-no" title="statement not covered" >    this.emit('update');</span>
  }
});
&nbsp;
//do the following after save on new instance
submissionSchema.post('new', <span class="fstat-no" title="function not covered" >function(){</span>
  //lookup challenge for submission
<span class="cstat-no" title="statement not covered" >  this</span>
  .populate({
    path: 'challenge',
    select: 'participants title',
    match: {"participants.inviteStatus": {$in: ['invited', 'accepted']}} //check inviteStatus
  }, <span class="fstat-no" title="function not covered" >function(err, submission){</span>
    //we have all users that have either accepted or invited to challenge, notify!
    //put returned participants into an array of userids
<span class="cstat-no" title="statement not covered" >    var users = _.pluck(submission.challenge.participants, 'user');</span>
<span class="cstat-no" title="statement not covered" >    User.sendNotifications({</span>
      users: users,
      payload: {
        alert: {
          'body': 'A new submission was made!',
          'action-loc-key': 'look at submission'
        },
        body: {
          'type': 'submission',
          '_id': submission._id,
          'title': submission.challenge.title
        }
      }
    }, <span class="fstat-no" title="function not covered" >function(err){</span>
<span class="cstat-no" title="statement not covered" >      if (err){</span>
<span class="cstat-no" title="statement not covered" >        console.error("Error! ", err, new Error().stack);</span>
      }
    });
<span class="cstat-no" title="statement not covered" >    submission.challenge.participants.forEach(<span class="fstat-no" title="function not covered" >function(user, index){</span></span>
      //send notification if they have not explicitly declined the challenge invite
<span class="cstat-no" title="statement not covered" >      console.log('Placeholder to send invite request to: ', user._id, 'invite status: ', user.inviteStatus);</span>
<span class="cstat-no" title="statement not covered" >      console.log('Type', 'submission', 'Id', submission._id, 'Title', submission.challenge.title);</span>
    });
  });
  //send notification to each user who is still subscribing to notifications
});
&nbsp;
//find challenge of a submission //TODO, we already store this, why the hell are we looking for it!?
submissionSchema.methods.findChallenge = <span class="fstat-no" title="function not covered" >function(next){</span>
  //find the challenge this submissions exists in and pass that to the callback
<span class="cstat-no" title="statement not covered" >  Challenge</span>
    .findOne({submissions: this._id})
    .populate({
      path: 'submissions', //populate submissions in the challenge
      select: 'score' //but only select submissions.score as that is all we will need
    })
    .select('submissions')//also only pass back challenge.submissions, we don't need the other challenge props
    .exec(<span class="fstat-no" title="function not covered" >function(err, challenge){</span>
<span class="cstat-no" title="statement not covered" >      if (!err &amp;&amp; challenge){</span>
<span class="cstat-no" title="statement not covered" >        next(null, challenge);</span>
      } else {
<span class="cstat-no" title="statement not covered" >        next(err, null);</span>
      }
    });
};
&nbsp;
//calculate the rank of an image
submissionSchema.methods.getRank = <span class="fstat-no" title="function not covered" >function(next){</span>
  //we have a virtual that we use to get the rank of the submission
<span class="cstat-no" title="statement not covered" >  var submission = this; </span>//keep this for when context changes
  //find the challenge this submission belongs to so we can get all the submissions in the group
<span class="cstat-no" title="statement not covered" >  this.findChallenge(<span class="fstat-no" title="function not covered" >function(err, challenge){</span></span>
<span class="cstat-no" title="statement not covered" >    if (!err &amp;&amp; challenge){</span>
      //sort the submissions in this challenge ordering by 'score'
<span class="cstat-no" title="statement not covered" >      var sortedSubmissions = _.sortBy(challenge.toJSON().submissions, 'score'); </span>//sort in ascending order by score
<span class="cstat-no" title="statement not covered" >      sortedSubmissions = _.chain(sortedSubmissions).reverse().value(); </span>//reverse the order so it is in descending order
      //now find where our submissions is in this sorted list
<span class="cstat-no" title="statement not covered" >      var index = _.chain(sortedSubmissions).map(<span class="fstat-no" title="function not covered" >function(obj){</span></span>
<span class="cstat-no" title="statement not covered" >        return obj._id.toJSON(); </span>//need to get the string version of the id
      }).indexOf(submission.id).value(); //find the index of the submission in the ordered array that matches the submission we are looking for
      //return that place in the ranking
<span class="cstat-no" title="statement not covered" >      next(index + 1); </span>//add one to the index to get the rank
    } else {
<span class="cstat-no" title="statement not covered" >      next(-1); </span>//some sort of error to investigate
    }
  });
};
&nbsp;
//help addImage to a submission
submissionSchema.methods.addImage = <span class="fstat-no" title="function not covered" >function(req, next){</span>
<span class="cstat-no" title="statement not covered" >  var gm = require('gm');</span>
<span class="cstat-no" title="statement not covered" >  var im = gm.subClass({ imageMagick: true });</span>
<span class="cstat-no" title="statement not covered" >  if (req.files){ //see if there are files first //TODO, this may not be a good way to see if files are there</span>
<span class="cstat-no" title="statement not covered" >    var uploadedImage = req.files[Object.keys(req.files)[0]]; </span>//get the first file in the list of files
<span class="cstat-no" title="statement not covered" >    this.image.contentType = uploadedImage.type;</span>
<span class="cstat-no" title="statement not covered" >    this.image.data = fs.readFileSync(uploadedImage.path); </span>//TODO, this should be async, this is blocking and slow
    //TODO cleanup this file also
    //make the thumbnail too
<span class="cstat-no" title="statement not covered" >    var thumbPath = uploadedImage.path + "thumb"; </span>//set thumb path for future use
<span class="cstat-no" title="statement not covered" >    var that = this;</span>
<span class="cstat-no" title="statement not covered" >    im(uploadedImage.path).thumb(90, 90, thumbPath, 90, //should go in own addThumbnail function</span>
<span class="fstat-no" title="function not covered" >      function(err, stdout, stderr, command){</span>
<span class="cstat-no" title="statement not covered" >        that.thumbnail.contentType = uploadedImage.type;</span>
<span class="cstat-no" title="statement not covered" >        that.thumbnail.data = fs.readFileSync(thumbPath);</span>
<span class="cstat-no" title="statement not covered" >        next();</span>
      });
&nbsp;
  } else {
<span class="cstat-no" title="statement not covered" >    next();</span>
  }
};
//Build the submission model
var Submission = mongoose.model('Submission', submissionSchema);
&nbsp;
module.exports = Submission;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jul 28 2014 22:37:28 GMT-0700 (PDT)</div>
</div>

<script src="../../prettify.js"></script>

<script src="https://yui-s.yahooapis.com/3.6.0/build/yui/yui-min.js"></script>
<script>

    YUI().use('datatable', function (Y) {

        var formatters = {
          pct: function (o) {
              o.className += o.record.get('classes')[o.column.key];
              try {
                  return o.value.toFixed(2) + '%';
              } catch (ex) { return o.value + '%'; }
          },
          html: function (o) {
              o.className += o.record.get('classes')[o.column.key];
              return o.record.get(o.column.key + '_html');
          }
        },
          defaultFormatter = function (o) {
              o.className += o.record.get('classes')[o.column.key];
              return o.value;
          };

        function getColumns(theadNode) {
            var colNodes = theadNode.all('tr th'),
                cols = [],
                col;
            colNodes.each(function (colNode) {
                col = {
                    key: colNode.getAttribute('data-col'),
                    label: colNode.get('innerHTML') || ' ',
                    sortable: !colNode.getAttribute('data-nosort'),
                    className: colNode.getAttribute('class'),
                    type: colNode.getAttribute('data-type'),
                    allowHTML: colNode.getAttribute('data-html') === 'true' || colNode.getAttribute('data-fmt') === 'html'
                };
                col.formatter = formatters[colNode.getAttribute('data-fmt')] || defaultFormatter;
                cols.push(col);
            });
            return cols;
        }

        function getRowData(trNode, cols) {
            var tdNodes = trNode.all('td'),
                    i,
                    row = { classes: {} },
                    node,
                    name;
            for (i = 0; i < cols.length; i += 1) {
                name = cols[i].key;
                node = tdNodes.item(i);
                row[name] = node.getAttribute('data-value') || node.get('innerHTML');
                row[name + '_html'] = node.get('innerHTML');
                row.classes[name] = node.getAttribute('class');
                //Y.log('Name: ' + name + '; Value: ' + row[name]);
                if (cols[i].type === 'number') { row[name] = row[name] * 1; }
            }
            //Y.log(row);
            return row;
        }

        function getData(tbodyNode, cols) {
            var data = [];
            tbodyNode.all('tr').each(function (trNode) {
                data.push(getRowData(trNode, cols));
            });
            return data;
        }

        function replaceTable(node) {
            if (!node) { return; }
            var cols = getColumns(node.one('thead')),
                data = getData(node.one('tbody'), cols),
                table,
                parent = node.get('parentNode');

            table = new Y.DataTable({
                columns: cols,
                data: data,
                sortBy: 'file'
            });
            parent.set('innerHTML', '');
            table.render(parent);
        }

        Y.on('domready', function () {
            replaceTable(Y.one('div.coverage-summary table'));
            if (typeof prettyPrint === 'function') {
                prettyPrint();
            }
        });
    });
</script>
</body>
</html>
